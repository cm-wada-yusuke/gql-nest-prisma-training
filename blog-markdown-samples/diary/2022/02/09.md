---
title: "Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚‰ Cloud SQL ã«ã¤ãªãŒã‚‰ãšã«ã‚¨ãƒ©ãƒ¼"
emoji: "ğŸ—’"
publishDate: "2022-02-09"
type: "diary"
published: true
---

`gcloud run deploy`ã‚³ãƒãƒ³ãƒ‰ã§ç™ºç”Ÿã€‚

```
Cloud SQL instance "project_id:us-central1:project_id-db-instance" is not reachable.
```

`--add-cloudsql-instances=$_CLOUDSQL_INSTANCE_FULL_NAME` ã¯ã¡ã‚ƒã‚“ã¨ä»˜ä¸ã—ã¦ã„ã‚‹ã®ã«ã©ã†ã—ã¦â€¦ã€‚

# Secret Manager ã®ç’°å¢ƒå¤‰æ•°ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¦ã„ã‚‹ç®‡æ‰€ã®è¨­å®šãƒŸã‚¹ã ã£ãŸ

æ¤œè¨¼ä¸­ã«Secret Managerã®åå‰ã‚’å¤‰ãˆãŸã®ã ã£ãŸã€‚

`DATABASE_URL` => `BLOG_TRAINING_DATABASE_URL`

ã‚¢ãƒ—ãƒªã¨ã—ã¦ã¯ `DATABASE_URL` ã®ã¾ã¾ä½¿ã„ãŸã„ãŒã€ãã®å®Ÿæ…‹ã¯ `BLOG_TRAINING_DATABASE_URL` ã‚’ä½¿ã„ãŸã„ã€‚ã¨ã„ã†ã“ã¨ã§ã“ã†ã—ãªã‘ã‚Œã°ãªã‚‰ãªã„

```diff yml:cloudbuild.yml
  - id: deploy-backend
    name: gcr.io/cloud-builders/gcloud
    args:
      - beta
      - run
      - deploy
      - training-backend
      - --quiet
      - --platform=managed
      - --project=$PROJECT_ID
      - --region=$_REGION
      - --image=$_ARTIFACT_REPOSITORY_IMAGE_NAME:$SHORT_SHA
      - --service-account=$_SERVICE_ACCOUNT
      - --add-cloudsql-instances=$_CLOUDSQL_INSTANCE_FULL_NAME
-      - --update-secrets=DATABASE_URL=DATABASE_URL:latest
+      - --update-secrets=DATABASE_URL=BLOG_TRAINING_DATABASE_URL:latest
      - --no-use-http2
      - --allow-unauthenticated
      - --no-cpu-throttling
      - --ingress=all
      - --set-env-vars=GCP_PROJECT_ID=$PROJECT_ID
```